<% if @posts.present? %>
  <?xml version="1.0" encoding="UTF-8"?>
  <feed xmlns="http://www.w3.org/2005/Atom"
        xmlns:thr="http://purl.org/syndication/thread/1.0"
        xml:base="<%= site_url %><%= request.path %>"
        xml:lang="en-us">

    <id><%= site_url %><%= request.path %></id>
    <link rel="alternate" type="text/html"            href="<%= site_url %><%= request.path.sub("/feed", "") %>" />
    <link rel="self"      type="application/atom+xml" href="<%= site_url %><%= request.path %>" />

    <title><%= setting :site_title       %> <%= ": #{@page_title}" if @page_title.present? %></title>
    <subtitle><%= Nokogiri::HTML(setting :site_description).text.gsub(/\n/, '') %></subtitle>

    <link href="./" />
    <link rel="self" href="" />

    <logo><%= largest_touch_icon_url %></logo>
    <icon><%= setting :favicon_url_16x16_or_32x32 %></icon>

    <updated><%= @posts.first.updated_at.xmlschema %></updated>

    <author>
      <name><%= @owner.try(:name) %></name>
      <email><%= @owner.try(:email) %></email>
    </author>

    <rights>
      <%= license.gsub(/\n/, blank).gsub(/\s+/, space) %>
    </rights>

    <generator uri="http://darkmatterapp.com">Generated by Dark Matter.</generator>

    <% @posts.each do |post| %>
      <entry>
        <id><%= canonical_url post %></id>
        <published><%= post.published_at.xmlschema %></published>
        <updated><%= post.updated_at.xmlschema %></updated>
        <link rel="alternate" type="text/html" href="<%= canonical_url post %>"/>

        <title><%= post.name %></title>

        <% post.tags.each do |tag| %>
          <category scheme="<%= tag.display_name %>" term="<%= tag.display_name %>" />
        <% end %>

        <content type="html">
          <%# TEMP limited to just content attribute %>
          <%= post.content %>

          <%# TODO figure out how to render an html format partial from an atom view  %>
          <%#= render partial: "#{post.namespace}/#{post.type}.html.erb", locals: { post: post } %>
        </content>

        <author>
          <name><%= post.user.name %></name>
          <email><%= post.user.email %></email>
        </author>
      </entry>
    <% end %>

  </feed>
<% end %>
